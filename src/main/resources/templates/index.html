<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Ticketing UI</title>
    <meta charset="UTF-8"/>

    <style>
        body { font-family: Arial; padding: 20px; }

        .box {
            border: 1px solid #bbb;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .seat-grid {
            display: grid;
            grid-template-columns: repeat(10, 50px);
            gap: 10px;
            margin-top: 20px;
        }

        .seat {
            padding: 8px;
            background: #eaeaea;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
        }

        .seat.selected {
            background: #00aaff;
            color: white;
        }

        .seat.held {
            background: #ff9800;
            color: white;
        }

        .seat.sold {
            background: #d32f2f;
            color: white;
        }

        pre {
            background: #f7f7f7;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<h1>üéüÔ∏è Ticketing System UI</h1>

<!-- Create Event -->
<div class="box">
    <h2>Create Event</h2>
    <input type="text" id="eventName" placeholder="Event name">
    <input type="text" id="eventDesc" placeholder="Description">
    <button onclick="uiCreateEvent()">Create</button>
    <pre id="eventResult"></pre>
</div>

<!-- Create Section -->
<div class="box">
    <h2>Create Section</h2>
    <input type="number" id="sectionEventId" placeholder="Event ID">
    <input type="text" id="sectionName" placeholder="Section Name">
    <input type="number" id="sectionSeats" placeholder="Total Seats">
    <input type="number" id="sectionPrice" placeholder="Price">
    <button onclick="uiCreateSection()">Create</button>
    <pre id="sectionResult"></pre>
</div>

<!-- Combined Seat Selection + Hold + Confirm -->
<div class="box">
    <h2>Select Seats & Reserve</h2>

    <input type="number" id="gridSectionId" placeholder="Section ID">
    <input type="number" id="gridEventId" placeholder="Event ID">
    <input type="text" id="gridUserId" placeholder="User ID">
    <button onclick="loadSeatGrid()">Load Seats</button>

    <div id="seatGrid" class="seat-grid"></div>

    <button onclick="holdSelectedSeats()" style="margin-top:20px;">Hold Seats</button>
    <button onclick="confirmHeldSeats()" style="margin-top:20px;">Confirm Reservation</button>

    <pre id="reserveResult"></pre>
</div>

<script>
    let selectedSeats = [];
    let currentReservationId = null;

    async function api(url, method = "GET", body = null) {
        const config = { method, headers: { "Content-Type": "application/json" } };
        if (body) config.body = JSON.stringify(body);
        const res = await fetch(url, config);
        return await res.json().catch(() => ({message:"No JSON"}));
    }

    async function uiCreateEvent() {
        let data = await api("/api/events", "POST", {
            name: document.getElementById("eventName").value,
            description: document.getElementById("eventDesc").value
        });
        document.getElementById("eventResult").textContent = JSON.stringify(data, null, 2);
    }

    async function uiCreateSection() {
        let data = await api("/api/events/sections", "POST", {
            eventId: Number(document.getElementById("sectionEventId").value),
            name: document.getElementById("sectionName").value,
            totalSeats: Number(document.getElementById("sectionSeats").value),
            price: Number(document.getElementById("sectionPrice").value)
        });
        document.getElementById("sectionResult").textContent = JSON.stringify(data, null, 2);
    }

    async function loadSeatGrid() {
        const sectionId = document.getElementById("gridSectionId").value;

        let res = await fetch(`/api/events/sections/${sectionId}/seats`);
        let seats = await res.json();

        let grid = document.getElementById("seatGrid");
        grid.innerHTML = "";
        selectedSeats = [];

        seats.forEach(seat => {
            let div = document.createElement("div");
            div.className = "seat";
            div.textContent = seat.seatLabel; // FIXED: correct property
            if (seat.status === "HELD") div.classList.add("held");
            if (seat.status === "SOLD") div.classList.add("sold");

            div.onclick = () => toggleSeat(div, seat.seatLabel);
            grid.appendChild(div);
        });
    }

    function toggleSeat(div, label) {
        if (div.classList.contains("held") || div.classList.contains("sold")) return;

        div.classList.toggle("selected");

        if (selectedSeats.includes(label)) {
            selectedSeats = selectedSeats.filter(s => s !== label);
        } else {
            selectedSeats.push(label);
        }
    }

    async function holdSelectedSeats() {
        if (selectedSeats.length === 0) {
            alert("Select at least one seat!");
            return;
        }

        let body = {
            eventId: Number(document.getElementById("gridEventId").value),
            sectionId: Number(document.getElementById("gridSectionId").value),
            seatLabels: selectedSeats,
            userId: document.getElementById("gridUserId").value
        };

        let data = await api("/api/reservations/hold", "POST", body);

        currentReservationId = data.id;
        document.getElementById("reserveResult").textContent = JSON.stringify(data, null, 2);

        await loadSeatGrid();
    }

    async function confirmHeldSeats() {
        if (!currentReservationId) {
            alert("Hold seats first!");
            return;
        }

        let data = await api(`/api/reservations/${currentReservationId}/confirm`, "POST");
        document.getElementById("reserveResult").textContent = JSON.stringify(data, null, 2);

        await loadSeatGrid();
    }
</script>

</body>
</html>
